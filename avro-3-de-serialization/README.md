# spring-kafka-de-serialization-types
## `> avro-3-de-serialization`

This sample demonstrates a **producer** that pushes `News` messages to a topic in `Kafka` and a **consumer** that listens those messages from `Kafka`
- Producer serializes the message `key` using `StringSerializer` and the message `value` using `KafkaAvroSerializer`;
- Consumer deserializes message `key` using `StringSerializer` to the message `value` using `SpecificAvroWithSchemaDeserializer`;
- This type of serialization/deserialization uses `Schema Registry`;
- The Java class generated from the `Avro` schema **DOES NOT** need to have the same `name` and `package (or namespace)` in the producer and the consumer;
- We needed to implement the `SpecificAvroWithSchemaDeserializer` class;
- Producer creates the Kafka topics and Consumer doesn't.

## Start Environment

Before starting producer and consumer, the services present in `docker-compose.yml` file must be up and running as explained in [Start Environment](https://github.com/ivangfr/spring-kafka-de-serialization-types#start-environment) section of the main README

## Running applications using Maven

> **Note:** run `avro-3-producer-service` first so that it can create the `Kafka` topics

- **avro-3-producer-service**

  - Open a terminal navigate to `spring-kafka-de-serialization-types` root folder
  - Run application
    ```
    ./mvnw clean spring-boot:run --projects avro-3-de-serialization/avro-3-producer-service
    ```
    > The Java class `com.mycompany.avro3producerservice.avro.NewsMessage` is generated by the Avro file `news-message.avsc` present in `src/main/resources/avro` by running the command
    > ```
    > ./mvnw generate-sources --projects avro-3-de-serialization/avro-3-producer-service
    > ```
  - As soon as the producer is up and running, it will start pushing automatically and randomly `News` messages to `Kafka` topic `avro-3-de-serialization-news`. The default `delay` between messages is `3 seconds`.

- **avro-3-consumer-service**

  - Open another terminal and make sure you are in `spring-kafka-de-serialization-types` root folder
  - Run application
    ```
    ./mvnw clean spring-boot:run --projects avro-3-de-serialization/avro-3-consumer-service
    ```
    > The Java class `com.mycompany.avro3consumerservice.avro.NewsMessage` is generated by the Avro file `news-message.avsc` present in `src/main/resources/avro` by running the command
    > ```
    > ./mvnw generate-sources --projects avro-3-de-serialization/avro-3-consumer-service
    > ```
  - Once the consumer is up and running, it will start listening `News` messages from the `Kafka` topic `avro-3-de-serialization-news`

## Running applications as Docker containers

- ### Build Docker images

  - Open a terminal navigate to `spring-kafka-de-serialization-types` root folder
  - Run the following script to build the images
    - JVM
      ```
      ./docker-build.sh avro-3-de-serialization
      ```
    - Native
      ```
      ./docker-build.sh avro-3-de-serialization native
      ```

- ### Environment variables

  **avro-3-producer-service** and **avro-3-consumer-service**

  | Environment Variable   | Description                                                             |
  |------------------------|-------------------------------------------------------------------------|
  | `KAFKA_HOST`           | Specify host of the `Kafka` message broker to use (default `localhost`) |
  | `KAFKA_PORT`           | Specify port of the `Kafka` message broker to use (default `29092`)     |
  | `SCHEMA_REGISTRY_HOST` | Specify host of the `Schema Registry` to use (default `localhost`)      |
  | `SCHEMA_REGISTRY_PORT` | Specify port of the `Schema Registry` to use (default `8081`)           |

- ### Run Docker containers

  > **Note:** run `avro-3-producer-service` first so that it can create the `Kafka` topics

  - **avro-3-producer-service**

    In a terminal, run the following Docker command
    ```
    docker run --rm --name avro-3-producer-service -p 9088:9088 \
      -e KAFKA_HOST=kafka -e KAFKA_PORT=9092 -e SCHEMA_REGISTRY_HOST=schema-registry \
      --network=spring-kafka-de-serialization-types_default \
      ivanfranchin/avro-3-producer-service:1.0.0
    ```

  - **avro-3-consumer-service**

    In another terminal, run the Docker command below
    ```
    docker run --rm --name avro-3-consumer-service -p 9089:9089 \
      -e KAFKA_HOST=kafka -e KAFKA_PORT=9092 -e SCHEMA_REGISTRY_HOST=schema-registry \
      --network=spring-kafka-de-serialization-types_default \
      ivanfranchin/avro-3-consumer-service:1.0.0
    ```

## Shutdown

- Go to the terminals where the applications are running and press `Ctrl+C`
- Stop the services present in `docker-compose.yml` as explained in [Shutdown](https://github.com/ivangfr/spring-kafka-de-serialization-types#shutdown) section of the main README

## Cleanup

To remove the Docker images created by this example, go to a terminal and, inside `spring-kafka-de-serialization-types` root folder, run the following script
```
./remove-docker-images.sh avro-3-de-serialization
```

## Issues

`avro-3-consumer-service`: the following exception is thrown at startup
```
ERROR 1 --- [           main] o.s.boot.SpringApplication               : Application run failed

org.springframework.context.ApplicationContextException: Failed to start bean 'org.springframework.kafka.config.internalKafkaListenerEndpointRegistry'; nested exception is org.apache.kafka.common.KafkaException: Failed to construct kafka consumer
	at org.springframework.context.support.DefaultLifecycleProcessor.doStart(DefaultLifecycleProcessor.java:181) ~[na:na]
	at org.springframework.context.support.DefaultLifecycleProcessor.access$200(DefaultLifecycleProcessor.java:54) ~[na:na]
	at org.springframework.context.support.DefaultLifecycleProcessor$LifecycleGroup.start(DefaultLifecycleProcessor.java:356) ~[na:na]
	at java.lang.Iterable.forEach(Iterable.java:75) ~[na:na]
	at org.springframework.context.support.DefaultLifecycleProcessor.startBeans(DefaultLifecycleProcessor.java:155) ~[na:na]
	at org.springframework.context.support.DefaultLifecycleProcessor.onRefresh(DefaultLifecycleProcessor.java:123) ~[na:na]
	at org.springframework.context.support.AbstractApplicationContext.finishRefresh(AbstractApplicationContext.java:935) ~[na:na]
	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:586) ~[na:na]
	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:145) ~[na:na]
	at org.springframework.boot.SpringApplication.refresh(SpringApplication.java:730) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.6.2]
	at org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:412) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.6.2]
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:302) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.6.2]
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1301) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.6.2]
	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1290) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.6.2]
	at com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication.main(Avro3ConsumerServiceApplication.java:25) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:na]
Caused by: org.apache.kafka.common.KafkaException: Failed to construct kafka consumer
	at org.apache.kafka.clients.consumer.KafkaConsumer.<init>(KafkaConsumer.java:823) ~[na:na]
	at org.apache.kafka.clients.consumer.KafkaConsumer.<init>(KafkaConsumer.java:664) ~[na:na]
	at org.springframework.kafka.core.DefaultKafkaConsumerFactory.createRawConsumer(DefaultKafkaConsumerFactory.java:416) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.8.1]
	at org.springframework.kafka.core.DefaultKafkaConsumerFactory.createKafkaConsumer(DefaultKafkaConsumerFactory.java:384) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.8.1]
	at org.springframework.kafka.core.DefaultKafkaConsumerFactory.createConsumerWithAdjustedProperties(DefaultKafkaConsumerFactory.java:360) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.8.1]
	at org.springframework.kafka.core.DefaultKafkaConsumerFactory.createKafkaConsumer(DefaultKafkaConsumerFactory.java:327) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.8.1]
	at org.springframework.kafka.core.DefaultKafkaConsumerFactory.createConsumer(DefaultKafkaConsumerFactory.java:304) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.8.1]
	at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.<init>(KafkaMessageListenerContainer.java:758) ~[na:na]
	at org.springframework.kafka.listener.KafkaMessageListenerContainer.doStart(KafkaMessageListenerContainer.java:344) ~[na:na]
	at org.springframework.kafka.listener.AbstractMessageListenerContainer.start(AbstractMessageListenerContainer.java:430) ~[na:na]
	at org.springframework.kafka.listener.ConcurrentMessageListenerContainer.doStart(ConcurrentMessageListenerContainer.java:209) ~[na:na]
	at org.springframework.kafka.listener.AbstractMessageListenerContainer.start(AbstractMessageListenerContainer.java:430) ~[na:na]
	at org.springframework.kafka.config.KafkaListenerEndpointRegistry.startIfNecessary(KafkaListenerEndpointRegistry.java:338) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.8.1]
	at org.springframework.kafka.config.KafkaListenerEndpointRegistry.start(KafkaListenerEndpointRegistry.java:283) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:2.8.1]
	at org.springframework.context.support.DefaultLifecycleProcessor.doStart(DefaultLifecycleProcessor.java:178) ~[na:na]
	... 14 common frames omitted
Caused by: java.lang.IllegalArgumentException: Unable to get Avro Schema from the class 'com.mycompany.avro3consumerservice.avro.NewsMessage'
	at com.mycompany.avro3consumerservice.kafka.SpecificAvroWithSchemaDeserializer.getSchema(SpecificAvroWithSchemaDeserializer.java:62) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:na]
	at com.mycompany.avro3consumerservice.kafka.SpecificAvroWithSchemaDeserializer.configure(SpecificAvroWithSchemaDeserializer.java:24) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:na]
	at org.apache.kafka.clients.consumer.KafkaConsumer.<init>(KafkaConsumer.java:716) ~[na:na]
	... 28 common frames omitted
Caused by: java.lang.NoSuchFieldException: SCHEMA$
	at java.lang.Class.getDeclaredField(DynamicHub.java:2411) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:na]
	at com.mycompany.avro3consumerservice.kafka.SpecificAvroWithSchemaDeserializer.getSchema(SpecificAvroWithSchemaDeserializer.java:58) ~[com.mycompany.avro3consumerservice.Avro3ConsumerServiceApplication:na]
	... 30 common frames omitted
```